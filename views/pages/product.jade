extends ../partials/skeleton

block prescript
	script(type='text/javascript', src='https://cdn.auth0.com/js/lock-7.5.min.js')
	script(type='text/javascript', src='/scripts/formFunctions.js')
	script(type='text/javascript', src='/scripts/getXrate.js')
	script(type='text/javascript', src='/scripts/chosen.jquery.js')
	link(rel='stylesheet', href='/stylesheets/checkout.css')
	link(rel='stylesheet', href='/stylesheets/chosen.css')

block content

	#product
		#leftside
			.Wallop.Wallop--fade
				.Wallop-pagination
					each image in items.images
						if image == image[1]
							button.Wallop-dot.Wallop-dot--current
						else
							button.Wallop-dot
				.Wallop-list
					each image in items.images
						if image == image[0]
							.Wallop-item.Wallop-item--current
								img(src="#{image}")
						else
							.Wallop-item
								img(src="#{image}")
				i.material-icons.Wallop-nav.Wallop-buttonNext navigate_next
				i.material-icons.Wallop-nav.Wallop-buttonPrevious navigate_before
		#rightside.com
			.browse.com__section
				.animate.slideInRight
					a(href="/categories/")
						i.material-icons.back-btn arrow_back
					form(class="view-product", action="#", role="form", method="POST")
						p #{items.sex} > #{items.category}
						h1 #{items.title}

						.tags
							each tag in items.tags
								.tag
									p #{tag}

						.clear
						p.rating Average rating: #{(items.rating).replace('%', '') * .10} / 10

						h2.price #{items.price}

						each selection in items.option
							select(name="option")
								each option in selection
									option(value="#{option[0]}") #{option[0]}
							.clear
						button(class="purchase com__nav-link", data-index="1", type="button") Order

			.ship.com__section
				.animate.slideInRight
					a(class="com__nav-link", data-index="0")
						i.material-icons.back-btn arrow_back
					.transactionprogress
						a(class="com__nav-link", data-index="0")
							p Order
						i(class="material-icons") navigate_next
						p Shipping
						.clear
					if user
						h1 Shipping time.
						h3 What address should we ship to?
						#shipto
							input(id="shippingAddress", type="hidden", name="shippingAddress")
							if postage
								each address in postage
									.address-container(data-id="#{address._id}")
										h3 #{address.name}
										p #{address.address1}
										p #{address.city}

								.new-container
									h3 Want to use a different address?
									button.add-address-button New address
							else
								p You don't seem to have any saved addresses. Let's create one!
								button.add-address-button New address
							#add-address
								h3 New address:
								include ../partials/address-form
							.clear

						h3 Go express?
						.express
							label(for="express") Express shipping ($15)
							input(type="checkbox" name="shipping" value="express")
							p Our standard shipping often takes around 30 days. This is partly how we manage to keep our prices down, slower shipping = lower costs. Alternatively, feel free to pay $15 for express shipping (5 - 10 days).
							h3 Almost done.
						button(class="purchase com__nav-link", data-index="2", type="button") Checkout
					else
						h1 Hold up!
						h3="Please "
							a(href="#", onClick="signin()")="log in "
							span to continue.

			.checkout.com__section
				.animate.slideInRight
					a(class="com__nav-link", data-index="1")
						i.material-icons.back-btn arrow_back
					.transactionprogress
						a(class="com__nav-link", data-index="0")
							p Order
						i(class="material-icons") navigate_next
						a(class="com__nav-link", data-index="1")
							p Shipping
						i(class="material-icons") navigate_next
						p Checkout
						.clear
					if user
						h1 Checkout time.
						h3 How would you like to pay?
						form(id="checkout", method="post", action="/checkout")
							#payment-form
							input(type="submit", value="Pay #{items.price}")

					else
						h1 How did you get here?!
						h3="Please "
							a(href="#", onClick="signin()")="log in "
							span to continue.
block scripts
	script(type='text/javascript').
		// ~~~~~~~~~~~~~~~~~ BRAINTREE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// We generated a client token for you so you can test out this code
		// immediately. In a production-ready integration, you will need to
		// generate a client token on your server (see section below).

		$.get("/client_token/", function(data, error){
			var clientToken = data;
			braintree.setup(clientToken, "dropin", {
				container: "payment-form",
				onPaymentMethodReceived: function (obj) {
					console.log(obj);
					// Do some logic in here.
					// When you're ready to submit the form:
					$('#checkout').submit();
				}
			});
		});

		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

		// Update DOM | Looking pretty
		$('body').addClass('product man');
		$(".multiple-select").chosen({max_selected_options: 1});

		// ~~~~~~~~~~~~~~~~~ AUTH0 CODE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		var lock = new Auth0Lock('aDP9vhLVwnXkCUXCUXebeU6g6Y15tX6p', 'copicat.auth0.com');
		function signin() {
			lock.show({
				callbackURL: 'http://ec2-54-206-83-33.ap-southeast-2.compute.amazonaws.com:8080/login?redir=/#{root}?stage=1',
				responseType: 'code',
				authParams: {
					scope: 'openid profile'
				}
			});
		}
		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

		$('.add-address-button').on('click', function(){
			$( "#add-address" ).slideDown( "medium", function() {
				$('.add-address-button').css({
					display: 'none'
				})
			});
		});

		$("#new-address").submit(function(event) {

			/* stop form from submitting normally */
			event.preventDefault();

			/* get some values from elements on the page: */
			var $form = $(this),
				url = $form.attr('action');

			/* Send the data using post */
			var submission = 	$.post( url, {
				contactName: 	$('#contactName').val(),
				contactId: 		$('#contactId').val(),
				contactNumber: 	$('#contactNumber').val(),
				address1: 		$('#address1').val(),
				address2: 		$('#address2').val(),
				postalCity: 	$('#postalCity').val(),
				postalState: 	$('#postalState').val(),
				postalZip: 		$('#postalZip').val(),
				postalCountry: 	$('#postalCountry').val()
			});

			/* Alerts the results */
			submission.done(function( data ) {
				alert('success');
			});
		});

		// Set default Image
		$('#shipto').on('click', '.address-container', function() {
			// Outline selection
			$('.address-container').removeClass('active');
			$(this).addClass('active');

			// Get selection value
			var postal_id = $(this).attr('data-id');

			// Set value
			$('#shippingAddress').attr('value', postal_id);
		});

	script(type='text/javascript', src='/scripts/checkout-animations.js')
	script(type='text/javascript', src='/scripts/product-wallop.js')

	// Init checkout
	script(type='text/javascript').
		activeFirst(#{stage});
