extends ../partials/skeleton

block prescript
	script(type='text/javascript', src='https://cdn.auth0.com/js/lock-7.5.min.js')
	script(type='text/javascript', src='/scripts/formFunctions.js')
	script(type='text/javascript', src='/scripts/getXrate.js')
	link(rel='stylesheet', href='/stylesheets/checkout.css')
	script(type='text/javascript').
		console.log(#{items});
block content
	#product
		#leftside
			.Wallop.Wallop--fade
				.Wallop-pagination
					each image in items.images
						if image == image[1]
							button.Wallop-dot.Wallop-dot--current
						else
							button.Wallop-dot
				.Wallop-list
					each image in items.images
						if image == image[0]
							.Wallop-item.Wallop-item--current
								img(src="#{image}")
						else
							.Wallop-item
								img(src="#{image}")
				i.material-icons.Wallop-nav.Wallop-buttonNext navigate_next
				i.material-icons.Wallop-nav.Wallop-buttonPrevious navigate_before
		#rightside.com
			.browse.com__section
				.animate.slideInRight
					a(href="/categories/")
						i.material-icons.back-btn arrow_back
					form(class="view-product", action="#", role="form", method="POST")
						p #{items.sex} > #{items.category}
						h3 #{items.title}
						h5.rating Average rating: #{(items.rating).replace('%', '') * .10} / 10
						.tags
							each tag in items.tags
								.tag
									p #{tag}

						.clear
						if items.option
							h5 Options:
						each selection in items.option
							.input-field
								select(name="option")
									each option in selection
										option(value="#{option[0]}") #{option[0]}
							.clear

						h4.price #{items.price}

						button.com__nav-link.waves-effect.waves-light.btn-large(type="button", data-index="1")
							i.material-icons.left shopping_cart
							span Order
			.ship.com__section
				.animate.slideInRight
					a(class="com__nav-link", data-index="0")
						i.material-icons.back-btn arrow_back
					.transactionprogress
						a(class="com__nav-link", data-index="0")
							p Order
						i(class="material-icons") navigate_next
						p Shipping
						.clear
					if !user
						h3 Shipping time.
						h4 What address should we ship to?
						#shipto
							input(id="shippingAddress", type="hidden", name="shippingAddress")

							#loadAddress
								.loading.active
									h5 Loading postage data
									.preloader-wrapper.big.active
										.spinner-layer.spinner-red-only
											.circle-clipper.left
												.circle
											.gap-patch
												.circle
											.circle-clipper.right
												.circle
							#selectAddress
							.clear
							.new-container
								h5.add-address-title Want to use a different address?
								button.add-address-button.waves-effect.waves-light.btn(type="button", data-index="2")
									i.material-icons.left home
									label New address
								.loading
									.preloader-wrapper.big.active
										.spinner-layer.spinner-red-only
											.circle-clipper.left
												.circle
											.gap-patch
												.circle
											.circle-clipper.right
												.circle
							.clear
							#add-address
								h3 New address:
								include ../partials/address-form
							.clear

						.express
							h4 Go express?
							input(type="checkbox", id="expressShip", name="shipping", value="express")
							label(for="expressShip") Express shipping ($15)

							p Our standard shipping often takes around 30 days. This is partly how we manage to keep our prices down, slower shipping = lower costs. Alternatively, feel free to pay $15 for express shipping (5 - 10 days).

						button.com__nav-link.waves-effect.waves-light.btn-large(type="button", data-index="2")
							i.material-icons.left payment
							span Checkout
					else
						h3 Hold up!
						h4="Please "
							a(href="#", onClick="signin()")="log in "
							span to continue.

			.checkout.com__section
				.animate.slideInRight
					a(class="com__nav-link", data-index="1")
						i.material-icons.back-btn arrow_back
					.transactionprogress
						a(class="com__nav-link", data-index="0")
							p Order
						i(class="material-icons") navigate_next
						a(class="com__nav-link", data-index="1")
							p Shipping
						i(class="material-icons") navigate_next
						p Checkout
						.clear
					if !user
						h3 Checkout time.
						h4 How would you like to pay?
						form(id="checkout", method="post", action="/checkout")
							#payment-form
							button.waves-effect.waves-light.btn-large(type="submit")
								i.material-icons.left thumb_up
								Pay #{items.price}



					else
						h3 How did you get here?!
						h4="Please "
							a(href="#", onClick="signin()")="log in "
							span to continue.
block scripts
	script(type='text/javascript').

		$(document).ready(function() {
			$('select').material_select();
		});

		// ~~~~~~~~~~~~~~~~~ BRAINTREE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		// We generated a client token for you so you can test out this code
		// immediately. In a production-ready integration, you will need to
		// generate a client token on your server (see section below).

		$.get("/client_token/", function(data, error){
			var clientToken = data;
			braintree.setup(clientToken, "dropin", {
				container: "payment-form",
				onPaymentMethodReceived: function (obj) {
					console.log(obj);
					// Do some logic in here.
					// When you're ready to submit the form:
					$('#checkout').submit();
				}
			});
		});

		$.get("/postage_api/#{user.id}", function(data){
			var clientAddresses = data;
			//Hide loader (#loadAddress)

			// push saved addresses to DOM (#selectAddress)
			if (data == 'none') {
				<p>You don't seem to have any saved addresses. Let's create one!</p>
				<button class="add-address-button">New address</button>
			} else {
				console.log(data);
				console.log(JSON.stringify(data));

			//	for (i=0; i < )
			//	each address in postage
			//		.address-container(data-id="#{address._id}")
			//			h5 #{address.name}
			//			p #{address.address1}
			//			p #{address.city}
			//	.clear

			}
		});

		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

		// Update DOM | Looking pretty
		$('body').addClass('product man');

		// ~~~~~~~~~~~~~~~~~ AUTH0 CODE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		var lock = new Auth0Lock('aDP9vhLVwnXkCUXCUXebeU6g6Y15tX6p', 'copicat.auth0.com');
		function signin() {
			lock.show({
				callbackURL: 'http://ec2-54-206-83-33.ap-southeast-2.compute.amazonaws.com:8080/login?redir=/#{root}?stage=1',
				responseType: 'code',
				authParams: {
					scope: 'openid profile'
				}
			});
		}
		// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

		// Set selected address effect
		$('#shipto').on('click', '.address-container', function() {
			// Outline selection
			$('.address-container').removeClass('active');
			$(this).addClass('active');

			// Get selection value
			var postal_id = $(this).attr('data-id');

			// Set value
			$('#shippingAddress').attr('value', postal_id);
		});

	script(type='text/javascript', src='/scripts/checkout-animations.js')
	script(type='text/javascript', src='/scripts/product-wallop.js')

	// Init checkout
	script(type='text/javascript').
		activeFirst(#{stage});
